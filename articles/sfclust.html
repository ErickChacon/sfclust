<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to sfclust • sfclust</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to sfclust">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sfclust</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/sfclust.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/vg02-additional-features.html">Additional features</a></li>
    <li><a class="dropdown-item" href="../articles/vg03-stars-object.html">Create stars dataset</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Applications</h6></li>
    <li><a class="dropdown-item" href="../articles/vg12-covid-usa.html">Weekly relative risk of COVID-19 in US states (2020)</a></li>
    <li><a class="dropdown-item" href="../articles/vg14-temp-canada.html">Standardized daily temperature at Canadian stations (1960–1994)</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Introduction to sfclust</h1>
            
      

      <div class="d-none name"><code>sfclust.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we demonstrate the basic use of
<code>sfclust</code> for spatial clustering. Specifically, we focus on a
synthetic dataset of disease cases to identify regions with similar
disease risk over time.</p>
<div class="section level2">
<h2 id="packages">Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h2>
<p>We begin by loading the required packages. In particular, we load the
<code>stars</code> package as our <code>sfclust</code> package works
with spacio-temporal <code>stars</code> objects.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">sfclust</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>The simulated dataset used in this vignette, <code>stbinom</code>, is
included in our package. It is a <code>stars</code> object with two
variables, <code>cases</code> and <code>population</code>, and two
dimensions, <code>geometry</code> and <code>time</code>. The dataset
represents the number of cases in 100 regions, observed daily over 91
days, starting in January 2024.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"stbinom"</span><span class="op">)</span></span></code></pre></div>
<p>We can easily visualize the spatio-temporal risk using
<code>ggplot</code> and <code><a href="https://r-spatial.github.io/stars/reference/geom_stars.html" class="external-link">stars::geom_stars</a></code>. It shows some
neightboring regions with similar risk patterns over time.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html" class="external-link">geom_stars</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">cases</span><span class="op">/</span><span class="va">population</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">stbinom</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"RdBu"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Daily risk"</span>, fill <span class="op">=</span> <span class="st">"Risk"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="sfclust_files/figure-html/unnamed-chunk-3-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>We can aggregate the data for easier visualization using the
<code><a href="https://r-spatial.github.io/stars/reference/aggregate.stars.html" class="external-link">stars::aggregate</a></code> function. The following figure displays
the weekly mean risk, providing initial insights. For This figure
displays the daily risk, providing initial insights. For example, the
northwestern regions show a higher risk at the beginning (2024-01-01),
followed by a decline by March 24. In contrast, a group of regions on
the eastern side exhibits high risk at both the beginning (2024-01-01)
and the end (2024-03-25) but lower values in the middle of the study
period (2024-02-12).</p>
<p>It is also useful to examine trends for each region. This can be done
by converting the <code>stars</code> object into a data frame using the
<code>stars::as_tibble</code> function. The visualization reveals that
some regions exhibit very similar trends over time. Our goal is to
cluster these regions while considering spatial contiguity.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stbinom</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_set_dimensions</a></span><span class="op">(</span><span class="st">"geometry"</span>, values <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">stbinom</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">cases</span><span class="op">/</span><span class="va">population</span>, group <span class="op">=</span> <span class="va">geometry</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Risk per region"</span>, y <span class="op">=</span> <span class="st">"Risk"</span>, x <span class="op">=</span> <span class="st">"Time"</span><span class="op">)</span></span></code></pre></div>
<p><img src="sfclust_files/figure-html/unnamed-chunk-5-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="clustering">Clustering<a class="anchor" aria-label="anchor" href="#clustering"></a>
</h2>
<div class="section level3">
<h3 id="model">Model<a class="anchor" aria-label="anchor" href="#model"></a>
</h3>
<p>Our model-based approach to spatial clustering requires defining a
within-cluster model, where regions within the same cluster share common
parameters and latent functions. In this example, given the clustering
or partition
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>M</mi><annotation encoding="application/x-tex">M</annotation></semantics></math>,
we assume that the observed number of cases
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">y_{it}</annotation></semantics></math>)
for region
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
is a realization of a Binomial random variable
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Y_{it}</annotation></semantics></math>
with size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">N_{it}</annotation></semantics></math>
and success probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">p_{it}</annotation></semantics></math>:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>∣</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>,</mo><msub><mi>N</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>,</mo><mi>M</mi><mover><mo>∼</mo><mrow><mi>i</mi><mi>n</mi><mi>d</mi></mrow></mover><mtext mathvariant="normal">Binomial</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>,</mo><msub><mi>N</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
Y_{it} \mid p_{it}, N_{it}, M \stackrel{ind}{\sim} \text{Binomial}(p_{it},N_{it}).
</annotation></semantics></math></p>
<p>Based on our exploratory analysis, the success probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">p_{it}</annotation></semantics></math>
is modeled as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">logit</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><msub><mi>c</mi><mi>i</mi></msub></msub><mo>+</mo><msubsup><mi>𝐱</mi><mi>t</mi><mi>T</mi></msubsup><msub><mi>𝛃</mi><msub><mi>c</mi><mi>i</mi></msub></msub><mo>+</mo><msub><mi>f</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>,</mo></mrow><annotation encoding="application/x-tex">
\text{logit}(p_{it}) =  \alpha_{c_i} + \boldsymbol{x}_{t}^T\boldsymbol{\beta}_{c_i} + f_{it},
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><msub><mi>c</mi><mi>i</mi></msub></msub><annotation encoding="application/x-tex">\alpha_{c_i}</annotation></semantics></math>
is the intercept for cluster
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>c</mi><mi>i</mi></msub><annotation encoding="application/x-tex">c_i</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐱</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\boldsymbol{x}_{t}</annotation></semantics></math>
represents a set of polynomial functions of time that capture global
trends with a cluster-specific effect
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝛃</mi><msub><mi>c</mi><mi>i</mi></msub></msub><annotation encoding="application/x-tex">\boldsymbol{\beta}_{c_i}</annotation></semantics></math>.
Additionally, we include an independent random effect,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mover><mo>∼</mo><mrow><mi>i</mi><mi>i</mi><mi>d</mi></mrow></mover><mtext mathvariant="normal">Normal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msub><mi>σ</mi><msub><mi>c</mi><mi>i</mi></msub></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f_{it} \stackrel{iid}{\sim} \text{Normal}(0, \sigma_{c_i})</annotation></semantics></math>,
to account for extra space-time variability.</p>
<p>Since we perform Bayesian inference, we impose prior distributions on
the model parameters. The intercept
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><msub><mi>c</mi><mi>i</mi></msub></msub><annotation encoding="application/x-tex">\alpha_{c_i}</annotation></semantics></math>
and regression coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝛃</mi><msub><mi>c</mi><mi>i</mi></msub></msub><annotation encoding="application/x-tex">\boldsymbol{\beta}_{c_i}</annotation></semantics></math>
follow a Normal distribution, while the prior for the hyperparameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><msub><mi>c</mi><mi>i</mi></msub></msub><annotation encoding="application/x-tex">\sigma_{c_i}</annotation></semantics></math>
is defined as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mi>/</mi><msub><mi>σ</mi><msub><mi>c</mi><mi>i</mi></msub></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>∼</mo><mtext mathvariant="normal">LogGamma</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>,</mo><msup><mn>10</mn><mrow><mo>−</mo><mn>5</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
\log(1/\sigma_{c_i}) \sim \text{LogGamma}(1, 10^{-5}).
</annotation></semantics></math> Notably, all regions within the same
cluster share the same parameters:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><msub><mi>c</mi><mi>i</mi></msub></msub><annotation encoding="application/x-tex">\alpha_{c_i}</annotation></semantics></math>,
regression coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝛃</mi><msub><mi>c</mi><mi>i</mi></msub></msub><annotation encoding="application/x-tex">\boldsymbol{\beta}_{c_i}</annotation></semantics></math>,
and random-effect standard deviation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><msub><mi>c</mi><mi>i</mi></msub></msub><annotation encoding="application/x-tex">\sigma_{c_i}</annotation></semantics></math>.</p>
</div>
<div class="section level3">
<h3 id="sampling-with-sfclust">Sampling with <code>sfclust</code><a class="anchor" aria-label="anchor" href="#sampling-with-sfclust"></a>
</h3>
<p>In order to perform Bayesian spatial functional clustering with the
model above we use the main function <code>sfclust</code>. The main
arguments of this function are:</p>
<ul>
<li>
<code>stdata</code>: The spatio-temporal data which should be a
<code>stars</code> object.</li>
<li>
<code>stnames</code>: Names of the spatial and time dimensions
respectively (default: <code>c("geometry", "time")</code>).</li>
<li>
<code>niter</code>: Number of iteration for the Markov chain Monte
Carlo algorithm.</li>
</ul>
<p>Notice that given that <code>sfclust</code> uses MCMC and INLA to
perform Bayesian inference, it accepts any argument of the
<code><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">INLA::inla</a></code> function. Some main arguments are:</p>
<ul>
<li>
<code>formula</code>: expression to define the model with fixed and
random effects. <code>sfclust</code> pre-process the data and create
identifiers for regions <code>ids</code>, times <code>idt</code> and
space-time <code>id</code>. You can incluse these identifiers in your
formula.</li>
<li>
<code>family</code>: distribution of the response variable.</li>
<li>
<code>Ntrials</code>: Number of trials in case of a Binomial
response.</li>
<li>
<code>E</code>: Expected number of cases for a Poisson
response.</li>
</ul>
<p>The following code perform the Bayesian function clustering for the
model explained above with 2000 iterations.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sfclust.html">sfclust</a></span><span class="op">(</span><span class="va">stbinom</span>, formula <span class="op">=</span> <span class="va">cases</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu">f</span><span class="op">(</span><span class="va">id</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"binomial"</span>, Ntrials <span class="op">=</span> <span class="va">population</span>, niter <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] "samples" "clust"</span></span></code></pre>
<p>The returning object is of class <code>sfclust</code>, which is a
list of two elements:</p>
<ul>
<li>
<code>samples</code>: list containing the <code>membership</code>
samples, the logarithm of the marginal likelihood <code>log_mlike</code>
and the clustering movements <code>move_counts</code> done in
total.</li>
<li>
<code>clust</code>: list containing the selecting
<code>membership</code> from <code>samples</code>. This include the
<code>id</code> of selected sample, the selected <code>membership</code>
and the <code>models</code> associated to each cluster.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="basic-methods">Basic methods<a class="anchor" aria-label="anchor" href="#basic-methods"></a>
</h2>
<div class="section level3">
<h3 id="print">Print<a class="anchor" aria-label="anchor" href="#print"></a>
</h3>
<p>By default, the <code>sfclust</code> object prints the within-cluster
model, the clustering hyperparameters, the movements counts, and the
current log marginal likelihood.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Within-cluster formula:</span></span>
<span><span class="co">#&gt; cases ~ poly(time, 2) + f(id)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Clustering hyperparameters:</span></span>
<span><span class="co">#&gt;   log(1-q)      birth      death     change      hyper </span></span>
<span><span class="co">#&gt; -0.6931472  0.4250000  0.4250000  0.1000000  0.0500000 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Clustering movement counts:</span></span>
<span><span class="co">#&gt;  births  deaths changes  hypers </span></span>
<span><span class="co">#&gt;      60      60      17      90 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log marginal likelihood (sample 2000 out of 2000): -61286.28</span></span></code></pre>
<p>The output indicates that the within-cluster model is specified using
the formula <code>cases ~ poly(time, 2) + f(id)</code>, which is
compatible with INLA. This formula includes polynomial fixed effects and
an independent random effect per observation.</p>
<p>The displayed hyperparameters are used in the clustering algorithm.
The hyperparameter <code>log(1-q) = 0.5</code> penalizes the increase of
clusters, while the other parameters control the probabilities of
different clustering movements:</p>
<ul>
<li>The probability of splitting a cluster is 0.425.</li>
<li>The probability of merging two clusters is 0.425.</li>
<li>The probability of simultaneously splitting and merging two clusters
is 0.1.</li>
<li>The probability of modifying the minimum spanning tree is 0.05.</li>
</ul>
<p>Users can modify these hyperparameters as needed. The output also
displays clustering movements. The output summary indicates the
following:</p>
<ul>
<li>Clusters were splited 60 times.</li>
<li>Clusters were merged 60 times.</li>
<li>Clusters were simultaneously split and merged 17 times.</li>
<li>The minimum spanning tree was updated 90 times.</li>
</ul>
<p>Finally, the log marginal likelihood for the last iteration (2000) is
reported as -61,286.28.</p>
</div>
<div class="section level3">
<h3 id="plot">Plot<a class="anchor" aria-label="anchor" href="#plot"></a>
</h3>
<p>The <code>plot</code> method generates three main graphs:</p>
<ol style="list-style-type: decimal">
<li>A map of the regions colored by clusters.</li>
<li>The mean function per cluster.</li>
<li>The marginal likelihood for each iteration.</li>
</ol>
<p>In our example, the left panel displays the regions grouped into the
10 clusters found in the 2000th (final) iteration. The middle panel
shows the mean linear predictor curves for each cluster. Some clusters
exhibit linear trends, while others follow quadratic trends. Although
some clusters have similar mean trends, they are classified separately
due to differences in other parameters, such as the variance of the
random effects.</p>
<p>Finally, the right panel presents the marginal likelihood for each
iteration. The values stabilize around iteration 1500, indicating that
any clustering beyond this point can be considered a reasonable
realization of the clustering distribution.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span>, sort <span class="op">=</span> <span class="cn">TRUE</span>, legend <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="sfclust_files/figure-html/unnamed-chunk-11-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h3>
<p>Once convergence is observed in the clustering algorithm, we can
summarize the results. By default, the summary is based on the last
sample. The output of the <code>summary</code> method confirms that it
corresponds to the 2000th sample out of a total of 2000. It also
displays the model formula, similar to the <code>print</code>
method.</p>
<p>Additionally, the summary provides the number of members in each
cluster. For example, in this case, Cluster 1 has 27 members, Cluster 2
has 12 members, and so on. Finally, it reports the associated
log-marginal likelihood.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Summary for clustering sample 2000 out of 2000 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Within-cluster formula:</span></span>
<span><span class="co">#&gt; cases ~ poly(time, 2) + f(id)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Counts per cluster:</span></span>
<span><span class="co">#&gt;  1  2  3  4  5  6  7  8  9 10 </span></span>
<span><span class="co">#&gt; 27 12  9  9 11 20  6  1  2  3 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log marginal likelihood:  -61286.28</span></span></code></pre>
<p>We can also summarize any other sample, such as the 500th iteration.
The output clearly indicates that the log-marginal likelihood is much
smaller in this case. Keep in mind that all other <code>sfclust</code>
methods use the last sample by default, but you can specify a different
sample if needed.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result</span>, sample <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Summary for clustering sample 500 out of 2000 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Within-cluster formula:</span></span>
<span><span class="co">#&gt; cases ~ poly(time, 2) + f(id)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Counts per cluster:</span></span>
<span><span class="co">#&gt;  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 </span></span>
<span><span class="co">#&gt; 26 12  9  8 11  4 16  1  5  1  2  1  2  1  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log marginal likelihood:  -61439.52</span></span></code></pre>
<p>Cluster labels are assigned arbitrarily, but they can be relabeled
based on the number of members using the option
<code>sort = TRUE</code>. The following output shows that, in the last
sample, the first seven clusters have more than four members, while the
last three clusters have fewer than four members.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Summary for clustering sample 2000 out of 2000 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Within-cluster formula:</span></span>
<span><span class="co">#&gt; cases ~ poly(time, 2) + f(id)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Counts per cluster:</span></span>
<span><span class="co">#&gt;  1  2  3  4  5  6  7  8  9 10 </span></span>
<span><span class="co">#&gt; 27 20 12 11  9  9  6  3  2  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log marginal likelihood:  -61286.28</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="fitted-values">Fitted values<a class="anchor" aria-label="anchor" href="#fitted-values"></a>
</h3>
<p>We can obtain the estimated values for our model using the
<code>fitted</code> function, which returns a <code>stars</code> object
in the same format as the original data. It provides the mean, standard
deviation, quantiles, and other summary statistics.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="va">pred</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; stars object with 2 dimensions and 5 attributes</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;                         Min.    1st Qu.        Median          Mean   3rd Qu.</span></span>
<span><span class="co">#&gt; mean              -0.7055731 -0.1988638 -0.0055543163 -0.0004677087 0.1850758</span></span>
<span><span class="co">#&gt; mean_inv           0.3305778  0.4504473  0.4986114245  0.4998542289 0.5461373</span></span>
<span><span class="co">#&gt; cluster            1.0000000  1.0000000  4.0000000000  3.8700000000 6.0000000</span></span>
<span><span class="co">#&gt; mean_cluster      -0.5011533 -0.1986104  0.0001815312 -0.0004677297 0.1898616</span></span>
<span><span class="co">#&gt; mean_cluster_inv   0.3772697  0.4505100  0.5000453828  0.4998533938 0.5473233</span></span>
<span><span class="co">#&gt;                         Max.</span></span>
<span><span class="co">#&gt; mean               0.6887139</span></span>
<span><span class="co">#&gt; mean_inv           0.6656808</span></span>
<span><span class="co">#&gt; cluster           10.0000000</span></span>
<span><span class="co">#&gt; mean_cluster       0.5015424</span></span>
<span><span class="co">#&gt; mean_cluster_inv   0.6228217</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;          from  to     offset  delta refsys point</span></span>
<span><span class="co">#&gt; geometry    1 100         NA     NA     NA FALSE</span></span>
<span><span class="co">#&gt; time        1  91 2024-01-01 1 days   Date FALSE</span></span>
<span><span class="co">#&gt;                                                                 values</span></span>
<span><span class="co">#&gt; geometry POLYGON ((59.5033 683.285...,...,POLYGON ((942.7562 116.89...</span></span>
<span><span class="co">#&gt; time                                                              NULL</span></span></code></pre>
<p>We can easily visualize these fitted values. Note that there are
still differences between regions within the same cluster due to the
presence of random effects at the individual level.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html" class="external-link">geom_stars</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mean_inv</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">pred</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"RdBu"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Daily risk"</span>, fill <span class="op">=</span> <span class="st">"Risk"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="sfclust_files/figure-html/unnamed-chunk-16-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>To gain further insights, we can compute the mean fitted values per
cluster using <code>aggregate = TRUE</code>. This returns a
<code>stars</code> object with cluster-level geometries.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">result</span>, sort <span class="op">=</span> <span class="cn">TRUE</span>, aggregate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Using these estimates, we can visualize the cluster-level mean risk
evolution over time.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html" class="external-link">geom_stars</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mean_cluster_inv</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">pred</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"RdBu"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Daily risk"</span>, fill <span class="op">=</span> <span class="st">"Risk"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="sfclust_files/figure-html/unnamed-chunk-18-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>Finally, we can use our clustering results to visualize the original
data grouped by clusters using the function
<code>plot_clusters_series()</code>. As the output is a
<code>ggplot</code> object, then we can easily customize the output as
follows:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_clusters_series</span><span class="op">(</span><span class="va">result</span>, <span class="va">cases</span><span class="op">/</span><span class="va">population</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">cluster</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Risk"</span><span class="op">)</span></span></code></pre></div>
<p><img src="sfclust_files/figure-html/unnamed-chunk-19-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>Even though some clusters exhibit similar trends—for example,
clusters 2 and 6—the variability between them differs, which justifies
their classification as separate clusters.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Erick A. Chacón-Montalván, Ruiman Zhong, Paula Moraga.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
