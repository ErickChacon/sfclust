<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Daily temperature at Canada stations • sfclust</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Daily temperature at Canada stations">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">sfclust</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/vg01-get-started.html">Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/vg02-additional-features.html">Additional features</a></li>
    <li><a class="dropdown-item" href="../articles/vg03-stars-object.html">Create stars dataset</a></li>
    <li><a class="dropdown-item" href="../articles/vg12-covid-usa.html">Covid-19 in US states during 2020</a></li>
    <li><a class="dropdown-item" href="../articles/vg14-temp-canada.html">Daily temperature at Canada stations</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Daily temperature at Canada stations</h1>
            
      

      <div class="d-none name"><code>vg14-temp-canada.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we use <code>sfclust</code> to clusterize Canada
stations with similar standardised temperature averaged over 1960 to
1994.</p>
<div class="section level2">
<h2 id="load-packages-and-data">Load packages and data<a class="anchor" aria-label="anchor" href="#load-packages-and-data"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">sfclust</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Loading required package: abind</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Loading required package: sf</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span></code></pre>
<pre><code><span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span></code></pre>
<pre><code><span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/rnaturalearth/" class="external-link">rnaturalearth</a></span><span class="op">)</span></span></code></pre></div>
<p>We will use the polygonal shapes of the Canada states using the
<code>rnaturalearth</code> package, and the common dataset
<code>CanadianWeather</code> for functional data analysis from the
<code>fda</code> package. Notice that this is a list containing the
daily data per stations, and other information such as the location of
the stations (<code>coordinates</code>).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canada</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rnaturalearth/reference/ne_states.html" class="external-link">ne_states</a></span><span class="op">(</span><span class="st">"Canada"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">CanadianWeather</span>, package <span class="op">=</span> <span class="st">"fda"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">CanadianWeather</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] "dailyAv"       "place"         "province"      "coordinates"  </span></span>
<span><span class="co">#&gt; [5] "region"        "monthlyTemp"   "monthlyPrecip" "geogindex"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="prepare-data">Prepare data<a class="anchor" aria-label="anchor" href="#prepare-data"></a>
</h2>
<div class="section level3">
<h3 id="create-stars-data">Create stars data<a class="anchor" aria-label="anchor" href="#create-stars-data"></a>
</h3>
<p>Firt, we will convert the stations to the class <code>sf</code>, and
visualize their locations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">CanadianWeather</span><span class="op">$</span><span class="va">coordinates</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>longitud <span class="op">=</span> <span class="op">-</span> <span class="va">`W.longitude`</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>latitud <span class="op">=</span> <span class="st">"N.latitude"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">longitud</span>, <span class="va">latitud</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longitud"</span>, <span class="st">"latitud"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">canada</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">stations</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="vg14-temp-canada_files/figure-html/unnamed-chunk-3-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>We standardised the temperature per station to be able to clusterize
based on the functional form rather than the absolute value. Then, we
convert the data to a stars object with dimensions <code>geometry</code>
and <code>time</code> as expected by <code>sfclust</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"1977-01-01"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"1977-12-31"</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"1 day"</span><span class="op">)</span></span>
<span><span class="va">canweather</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html" class="external-link">st_as_stars</a></span><span class="op">(</span></span>
<span>    temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">CanadianWeather</span><span class="op">$</span><span class="va">dailyAv</span><span class="op">[</span>, , <span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    ztemp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">CanadianWeather</span><span class="op">$</span><span class="va">dailyAv</span><span class="op">[</span>, , <span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    dimensions <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_dimensions</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">stations</span><span class="op">)</span>, time <span class="op">=</span> <span class="va">time</span>, point <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">canweather</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; stars object with 2 dimensions and 2 attributes</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;              Min.    1st Qu.     Median          Mean   3rd Qu.      Max.</span></span>
<span><span class="co">#&gt; temp   -34.800000 -6.7000000 4.10000000  1.877659e+00 12.600000 22.800000</span></span>
<span><span class="co">#&gt; ztemp   -1.967879 -0.9821809 0.09676872 -2.067071e-19  0.960108  1.711485</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;          from  to     offset  delta refsys point</span></span>
<span><span class="co">#&gt; geometry    1  35         NA     NA WGS 84  TRUE</span></span>
<span><span class="co">#&gt; time        1 365 1977-01-01 1 days   Date  TRUE</span></span>
<span><span class="co">#&gt;                                                 values</span></span>
<span><span class="co">#&gt; geometry POINT (-52.43 47.34),...,POINT (-94.54 74.41)</span></span>
<span><span class="co">#&gt; time                                              NULL</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="exploratory-analysis">Exploratory analysis<a class="anchor" aria-label="anchor" href="#exploratory-analysis"></a>
</h3>
<p>Let’s visualize the temperature averaged per month. We can observe
that higher values of standardised temperature have been observed in the
north station on July; while the lowest values have been observed on
January around some stations located around the south areas closed to
the center.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">monthdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">canweather</span>, by <span class="op">=</span> <span class="st">"month"</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">canada</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html" class="external-link">geom_stars</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">ztemp</span><span class="op">)</span>, <span class="va">monthdata</span>, shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">time</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"RdBu"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vg14-temp-canada_files/figure-html/unnamed-chunk-6-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>Additionally we can observe the temperal trends per regions. Although
the functional shapes seem similar, it is important to notice that the
temperature increases and decays at different times of the year per
station.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">canweather</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html" class="external-link">st_set_dimensions</a></span><span class="op">(</span><span class="st">"geometry"</span>, values <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">canweather</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">ztemp</span>, group <span class="op">=</span> <span class="va">geometry</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vg14-temp-canada_files/figure-html/unnamed-chunk-7-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="spatial-clustering">Spatial clustering<a class="anchor" aria-label="anchor" href="#spatial-clustering"></a>
</h2>
<div class="section level3">
<h3 id="create-graph">Create graph<a class="anchor" aria-label="anchor" href="#create-graph"></a>
</h3>
<p><code>sfclust</code> assumes that the <code>geometry</code> type of
the provided <code>stars</code> object if <code>POLYGON</code>, from
which it create a <code>igraph</code> using the adjacency matrix.
However, the processed <code>canweather</code> has <code>POINT</code> as
a geometry representing the locations of stations. In this case, it is
necessary to define a graph that captures the connectiviy to consider
between stations. For this, we will create a Voronoi tessellation with
will create a polygon for each station.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stations2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">stations</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="fl">3857</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create boundary</span></span>
<span><span class="va">boundary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_convex_hull</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">stations2</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="st">"km"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create polygons with voronoi</span></span>
<span><span class="va">domain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_voronoi</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">stations2</span><span class="op">)</span>, <span class="va">boundary</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">boundary</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># reorganize the polygons to match stations</span></span>
<span><span class="va">domain</span> <span class="op">&lt;-</span> <span class="va">domain</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_within</a></span><span class="op">(</span><span class="va">stations2</span>, <span class="va">domain</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">stations</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">domain</span>, color <span class="op">=</span> <span class="fl">2</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">stations</span><span class="op">)</span></span></code></pre></div>
<p><img src="vg14-temp-canada_files/figure-html/unnamed-chunk-8-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="model-fitting">Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h3>
<p>In this application, because of the trends observed before, we will
assume that the mean standardised temperature can be explained by (i) a
polynomial trend with respect to <code>time</code>, (ii) and an
autoregressive process over times units <code>idt</code> to capture
correlated temporal variation. Additionally, we will start assuming that
each state is a cluster, such us we will start with 35 clusters using
the created polygonal data (<code>domain</code>). Because of the
presence of strong noise on the curves, we will use a strong penalty
(-300) for the increase of parameters, it means that to have high
chances of accepting the creation a new cluster, then the log marginal
likelihood has be to improve by a value of 300, if the proposal has an
improvement on the marginal likelihood smaller than 300, it will
probably be rejected.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">ztemp</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="fu">f</span><span class="op">(</span><span class="va">idt</span>, model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span></span>
<span><span class="va">geodata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/genclust.html">genclust</a></span><span class="op">(</span><span class="va">domain</span>, nclust <span class="op">=</span> <span class="fl">35</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sfclust.html">sfclust</a></span><span class="op">(</span><span class="va">canweather</span>, graphdata <span class="op">=</span> <span class="va">geodata</span>, formula <span class="op">=</span> <span class="va">formula</span>,</span>
<span>    logpen <span class="op">=</span> <span class="op">-</span><span class="fl">300</span>, niter <span class="op">=</span> <span class="fl">4000</span>, burnin <span class="op">=</span> <span class="fl">0</span>, thin <span class="op">=</span> <span class="fl">10</span>, nmessage <span class="op">=</span> <span class="fl">10</span>, nsave <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    control.inla <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>control.vb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>enable <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    path_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"canweather-mcmc.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">result</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Within-cluster formula:</span></span>
<span><span class="co">#&gt; ztemp ~ poly(time, 2) + f(idt, model = "rw1")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Clustering hyperparameters:</span></span>
<span><span class="co">#&gt; log(1-q)    birth    death   change    hyper </span></span>
<span><span class="co">#&gt; -300.000    0.425    0.425    0.100    0.050 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Clustering movement counts:</span></span>
<span><span class="co">#&gt;  births  deaths changes  hypers </span></span>
<span><span class="co">#&gt;       8      29      19     171 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log marginal likelihood (sample 400 out of 400): 17541.96</span></span></code></pre>
<p>Notice that 8 times there was an increase of number of clusters, 29
times clusters were merged, 19 times the composition were modified, and
171 times the minimum spanning tree has been modified. Also after
thinning we keep 400 samples from a total of 4000, and the marginal
likelihood achieve a value of 17541.96.</p>
</div>
<div class="section level3">
<h3 id="results">Results<a class="anchor" aria-label="anchor" href="#results"></a>
</h3>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">result</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Summary for clustering sample 400 out of 400 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Within-cluster formula:</span></span>
<span><span class="co">#&gt; ztemp ~ poly(time, 2) + f(idt, model = "rw1")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Counts per cluster:</span></span>
<span><span class="co">#&gt;  1  2  3  4  5  6  7  8  9 10 11 12 13 14 </span></span>
<span><span class="co">#&gt;  7  7  4  3  2  2  2  2  1  1  1  1  1  1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Log marginal likelihood:  17541.96</span></span></code></pre>
<p>The <code>summary</code> indicates that 8 clusters from 14 have more
than one member, where the two biggest cluster includes 7 stations, the
third 4, and so on.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span>, sort <span class="op">=</span> <span class="cn">TRUE</span>, legend <span class="op">=</span> <span class="cn">TRUE</span>, geom_before <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">canada</span><span class="op">)</span>, clusters <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p><img src="vg14-temp-canada_files/figure-html/unnamed-chunk-13-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>Let’s create a map with the clustered stations.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">sfclust</span><span class="fu">:::</span><span class="fu">plot_clusters</span><span class="op">(</span><span class="va">result</span>, sort <span class="op">=</span> <span class="cn">TRUE</span>, legend <span class="op">=</span> <span class="cn">TRUE</span>, geom_before <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">canada</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  clusters <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p><img src="vg14-temp-canada_files/figure-html/unnamed-chunk-15-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>We can observe that the biggest cluster is located on the southeast
of Canada with the total of 7 close stations, while the second biggest
is located on the south conformed by 7 stations that are more further
apart. The third one, with 4 stations, is located on the southwest also
more further apart.</p>
</div>
<div class="section level3">
<h3 id="empirical-temperature-per-cluster">Empirical temperature per cluster<a class="anchor" aria-label="anchor" href="#empirical-temperature-per-cluster"></a>
</h3>
<p>We can use that information of the cluster assignment to visualize
the empirical data per cluster.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">sfclust</span><span class="fu">:::</span><span class="fu">plot_series</span><span class="op">(</span><span class="va">result</span>, <span class="st">"ztemp"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Standardised temperature"</span><span class="op">)</span></span></code></pre></div>
<p><img src="vg14-temp-canada_files/figure-html/unnamed-chunk-17-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>Panels 1-8, shows the empirical risk per cluster for those who have
more than 1 stations. The main differences between these clusters if the
initial shape, the speed of increase, the peak shape and time, the decay
behaviour. For example clusters 1 and 2 has a bell shape, while others
like 3-6 have almost a linear increase until reaching a maximum level.
Panels 9-14 shows the empirical risk per cluster for those who have only
1 station. Notice that these clusters have more particular shapes that
differentiate from the previous clusters, and between them.</p>
<!-- ```{r, fig.height = 5.4} -->
<!-- plot(result, which = 2, sort = TRUE, clusters = 9:14, legend = TRUE) -->
<!-- ``` -->
<!---->
<!-- ```{r, echo = FALSE} -->
<!-- ggsave(file.path(path_figures, "canweather-risk-per-cluster-2.pdf"), width = 10, height = 7.5, device = cairo_pdf) -->
<!-- ``` -->
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Erick A. Chacón-Montalván, Ruiman Zhong, Paula Moraga.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
